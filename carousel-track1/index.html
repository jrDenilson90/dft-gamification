<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Seleção de Tênis</title>
    <!-- <link rel="stylesheet" href="style.css"> -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700&family=Bebas+Neue&display=swap');

        body,
        html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            font-family: 'Inter', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            animation: fadeIn 0.3s ease-out;
        }

        .modal-content {
            background: #ffffff;
            width: 90dvw;
            max-width: 320px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            position: relative;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
        }
        
        @media screen and (-webkit-min-device-pixel-ratio: 3) {
            .modal-content {
                max-width: 400px;
                width: 92dvw;
            }
        }

        @media screen and (-webkit-min-device-pixel-ratio: 3) and (min-width: 400px) {
            .modal-content {
                max-width: 440px;
            }
        }
        .close-button {
            position: absolute;
            top: 12px;
            right: 12px;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.9);
            border: none;
            font-size: 18px;
            color: #666;
            cursor: pointer;
            z-index: 10;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .close-button:hover {
            background: white;
            color: #333;
            transform: scale(1.1);
        }

        /* ---------------- Slider core (ajustes feitos) ---------------- */
        .carousel-wrapper {
            width: 100%;
            overflow: hidden;
            /* importante: esconde o overflow horizontal */
        }

        /* track como flex row; transform aplicado ao track para animar */
        .carousel-track {
            display: flex;
            flex-direction: row;
            width: 100%;
            will-change: transform;
            transition: transform 300ms ease;
            /* controlado por JS quando necessário */
            touch-action: pan-y;
            /* permite scroll vertical nativo ao arrastar verticalmente */
        }

        /* cada slide ocupa 100% da largura do container (viewport do modal) */
        .carousel-slide {
            min-width: 100%;
            box-sizing: border-box;
            padding: 25px;
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: stretch;
            gap: 12px;
        }

        /* media container mantém aspecto e borda */
        .media-container {
            width: 100%;
            border-radius: 35px;
            overflow: hidden;
            margin-bottom: 12px;
            background-color: #f0f0f0;
        }

        @supports (corner-shape:squircle){
            .media-container {
                border-radius:82px;
                corner-shape:squircle;
            }
        }

        .media-container img,
        .media-container video {
            aspect-ratio: 1;
            width: 100%;
            height: 100%;
            display: block;
            object-fit: cover;
            pointer-events: none;
        }

        /* conteúdo textual */
        .slide-content .category {
            font-size: 12px;
            font-weight: 700;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin: 0 0 5px 0;
        }

        .slide-content h2 {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 28px;
            margin: 0 0 8px 0;
            color: #111;
            letter-spacing: 1px;
            line-height: 1;
        }

        .slide-content .description {
            font-size: 14px;
            line-height: 1.5;
            color: #555;
            margin: 0 0 18px 0;
            min-height: 56px;
        }

        /* CTA */
        .cta-button {
            display: inline-block;
            background-color: #000000;
            color: #ffffff;
            padding: 12px 28px;
            text-decoration: none;
            font-weight: bold;
            border-radius: 8px;
            font-size: 15px;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            align-self: center;
        }

        /* nav (dots) */
        .carousel-nav {
            align-items: center;
            bottom: 5px;
            display: flex;
            gap: 5px;
            justify-content: center;
            margin: 0;
            padding: 20px 0;
            width: 100%;
        }

        .carousel-nav:has(.nav-dot:nth-child(1):last-child) {
            display: none;
        }

        .nav-dot {
            background: 0 0;
            border: 1.5px solid #ffffff;
            box-shadow: 0 0 2px 1px rgba(0, 0, 0, .5);
            box-sizing: border-box;
            border-radius: 50%;
            cursor: pointer;
            padding: 0;
            transition: all 0.3s cubic-bezier(0.51, 0.92, 0.24, 1);
            height: 10px;
            width: 10px;
        }

        .nav-dot.active {
            border-radius: 11px;
            background: #ffffff;
            width: 28px;
        }

        /* small screens tweaks */
        @media (max-width: 420px) {
            .modal-content {
                max-width: 420px;
                border-radius: 12px;
            }

            .slide-content h2 {
                font-size: 26px;
            }

            .cta-button {
                padding: 10px 22px;
                font-size: 14px;
            }
        }

        /* animations */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: scale(0.95);
            }

            to {
                opacity: 1;
                transform: scale(1);
            }
        }
    </style>
</head>

<body>
    <div class="modal-overlay">
        <div class="modal-content">
            <button class="close-button" aria-label="Fechar" title="Fechar"
                onclick="try{braze.bridge.closeMessage()}catch(e){try{appboyBridge.closeMessage()}catch(e2){document.body.style.display='none';}}">&times;</button>

            <div class="carousel-wrapper">
                <div class="carousel-track" id="carouselTrack">

                    <div class="carousel-slide">
                        <div class="media-container">
                            <video autoplay muted loop playsinline src=""></video>
                            <img src="" alt="">
                        </div>
                        <div class="slide-content">
                            <p class="category"></p>
                            <h2 class="title"></h2>
                            <p class="description"></p>
                            <a href="dafiti://br/d/AD464SCF93VGG" class="cta-button"
                                data-tracking-id="cta_superstar_branco"></a>
                        </div>
                    </div>
                </div>
            </div>
            <div class="carousel-nav" id="carouselNav">
                <div class="nav-dot" data-slide="0"></div>
            </div>
        </div>
    </div>

    <!-- <script src="script.js"></script> -->
    <script>
        const DADOS_GAMES = {
            textCta: 'Ver detalhes',
            slides: [
                {
                    video: 'https://static.dafiti.com.br/cms/onsite/2025/nike-cortez20251105.mp4',
                    marca: 'Nike',
                    titulo: 'Nike Cortez Feminino',
                    description: 'O clássico que conquistou as ruas está de volta com tudo. O Nike Cortez Feminino traz o estilo retrô que você ama, agora com um toque moderno para o seu dia a dia.',
                    link: 'dafiti://br/d/NI288SHF58GAB',
                    trackingId: 'cta_nike_cortez'
                }
            ]
        };

        document.addEventListener('DOMContentLoaded', () => {
            const wrapper = document.querySelector('.carousel-wrapper') || document.getElementById('carouselTrack')?.parentElement;
            const track = document.getElementById('carouselTrack');
            const nav = document.getElementById('carouselNav');

            let currentIndex = 0;
            const slideCount = DADOS_GAMES.slides.length;

            // estado do drag (em px)
            let isPointerDown = false;
            let isDragging = false;
            let startX = 0;
            let currentTranslatePx = 0;
            let prevTranslatePx = 0;
            let rafId = null;

            // config
            const threshold = 0.5;      // 0.5 => 50% do slide width
            const dragDetectPx = 5;    // precisa mover >= 5px para iniciar drag
            const transitionDuration = 220; // ms

            // util
            function escapeHtml(str) {
                if (str === null || str === undefined) return '';
                return String(str)
                    .replaceAll('&', '&amp;')
                    .replaceAll('<', '&lt;')
                    .replaceAll('>', '&gt;')
                    .replaceAll('"', '&quot;')
                    .replaceAll("'", '&#39;');
            }

            function createSlideHTML(item, idx) {
                const media = item.video
                    ? `<video muted loop playsinline src="${escapeHtml(item.video)}"></video>`
                    : `<img loading="lazy" src="${escapeHtml(item.img)}" alt="${escapeHtml(item.titulo || '')}">`;

                return `
                    <div class="carousel-slide" data-index="${idx}" style="min-width:100%; box-sizing:border-box;">
                    <div class="media-container">${media}</div>
                    <div class="slide-content">
                        <p class="category">${escapeHtml(item.marca || '')}</p>
                        <h2 class="title">${escapeHtml(item.titulo || '')}</h2>
                        <p class="description">${escapeHtml(item.description || '')}</p>
                        <a href="${escapeHtml(item.link || '#')}" class="cta-button" data-tracking-id="${escapeHtml(item.trackingId || '')}">${escapeHtml(DADOS_GAMES.textCta)}</a>
                    </div>
                    </div>
                `;
            }

            // calculo largura do slide visível (wrapper clientWidth)
            function getSlideWidth() {
                if (!wrapper) return window.innerWidth;
                return wrapper.clientWidth;
            }

            // render
            function render() {
                track.innerHTML = '';
                nav.innerHTML = '';

                DADOS_GAMES.slides.forEach((it, i) => {
                    track.insertAdjacentHTML('beforeend', createSlideHTML(it, i));
                    const dot = document.createElement('div');
                    dot.className = 'nav-dot';
                    dot.setAttribute('data-slide', String(i));
                    dot.setAttribute('role', 'button');
                    dot.setAttribute('aria-label', `Ir para slide ${i + 1}`);
                    dot.tabIndex = 0;
                    dot.addEventListener('click', () => goTo(i));
                    nav.appendChild(dot);
                });

                // inicializa posição
                updateActiveDot();
                setTranslateForIndex(currentIndex, false);
                attachCTAListeners();
                ensureVideoAutoplay();
                addPointerEvents();
            }

            function updateActiveDot() {
                const dots = nav.querySelectorAll('.nav-dot');
                dots.forEach(d => d.classList.remove('active'));
                const active = nav.querySelector(`.nav-dot[data-slide="${currentIndex}"]`);
                if (active) active.classList.add('active');
            }

            function setTranslateForIndex(index, withTransition) {
                const slideW = getSlideWidth();
                const targetPx = -index * slideW;
                if (withTransition) track.style.transition = `transform ${transitionDuration}ms ease`;
                else track.style.transition = 'none';
                track.style.transform = `translateX(${targetPx}px)`;
                prevTranslatePx = targetPx;
                currentTranslatePx = targetPx;
            }

            function goTo(index) {
                if (index < 0) index = 0;
                if (index >= slideCount) index = slideCount - 1;
                currentIndex = index;
                updateActiveDot();
                setTranslateForIndex(currentIndex, true);
                handleVideoPlayback();
            }

            function goNext() { goTo(currentIndex + 1); }
            function goPrev() { goTo(currentIndex - 1); }

            // video helpers
            function ensureVideoAutoplay() {
                const firstVideo = track.querySelector('video');
                if (firstVideo) {
                    firstVideo.muted = true;
                    const p = firstVideo.play();
                    if (p !== undefined) p.catch(() => { });
                }
            }
            function handleVideoPlayback() {
                const slidesEls = track.querySelectorAll('.carousel-slide');
                slidesEls.forEach((s, idx) => {
                    const v = s.querySelector('video');
                    if (v) {
                        if (idx === currentIndex) {
                            v.muted = true;
                            const p = v.play();
                            if (p !== undefined) p.catch(() => { });
                        } else {
                            try { v.pause(); v.currentTime = 0; } catch (e) { }
                        }
                    }
                });
            }

            // tracking CTA (evita clique após drag)
            function attachCTAListeners() {
                const ctas = track.querySelectorAll('.cta-button');
                ctas.forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        if (isDragging) {
                            e.preventDefault();
                            e.stopImmediatePropagation();
                            return;
                        }
                        const id = btn.getAttribute('data-tracking-id');
                        if (id) {
                            try { window.brazeBridge && brazeBridge.logClick && brazeBridge.logClick(id); } catch (err) { }
                        }
                    });
                });
            }

            // pointer events (baseado em px)
            function addPointerEvents() {
                track.addEventListener('pointerdown', onPointerDown);
                track.addEventListener('pointermove', onPointerMove);
                window.addEventListener('pointerup', onPointerUp);
                window.addEventListener('pointercancel', onPointerUp);
                track.style.touchAction = 'pan-y';
                window.addEventListener('resize', () => {
                    // ao redimensionar, recalcula a posição para o slide atual
                    setTranslateForIndex(currentIndex, false);
                });
            }

            function onPointerDown(e) {
                isPointerDown = true;
                isDragging = false;
                startX = getClientX(e);
                // sem transição enquanto arrasta
                track.style.transition = 'none';
                try { track.setPointerCapture && track.setPointerCapture(e.pointerId); } catch (_) { }
                rafId = requestAnimationFrame(renderWhileDragging);
            }

            function onPointerMove(e) {
                if (!isPointerDown) return;
                const x = getClientX(e);
                const movedPx = x - startX;

                // inicia drag somente se mover o suficiente
                if (!isDragging && Math.abs(movedPx) > dragDetectPx) {
                    isDragging = true;
                }
                if (!isDragging) return;

                // usa prevTranslatePx + movedPx, mas clamp entre limites
                const slideW = getSlideWidth();
                const tentativePx = prevTranslatePx + movedPx;
                const maxPx = 0;
                const minPx = -((slideCount - 1) * slideW);
                currentTranslatePx = Math.max(Math.min(tentativePx, maxPx), minPx);

                // apply immediate transform (via RAF loop)
            }

            function onPointerUp(e) {
                if (!isPointerDown) return;
                isPointerDown = false;
                cancelAnimationFrame(rafId);

                const endX = getClientX(e);
                const movedPx = endX - startX;
                const slideW = getSlideWidth();
                const neededPx = slideW * threshold;

                if (isDragging) {
                    if (movedPx <= -neededPx && currentIndex < slideCount - 1) {
                        currentIndex += 1;
                    } else if (movedPx >= neededPx && currentIndex > 0) {
                        currentIndex -= 1;
                    }
                    updateActiveDot();
                    setTranslateForIndex(currentIndex, true);
                    handleVideoPlayback();
                } else {
                    // clique curto: restaura a posição do slide atual
                    setTranslateForIndex(currentIndex, true);
                }

                // atualiza prevTranslatePx (fixa posição)
                prevTranslatePx = -currentIndex * slideW;
                currentTranslatePx = prevTranslatePx;

                try { track.releasePointerCapture && track.releasePointerCapture(e.pointerId); } catch (_) { }
                // limpa flag de dragging ligeiramente depois para permitir clicks
                setTimeout(() => { isDragging = false; }, 50);
            }

            function renderWhileDragging() {
                track.style.transform = `translateX(${currentTranslatePx}px)`;
                if (isPointerDown) rafId = requestAnimationFrame(renderWhileDragging);
            }

            function getClientX(e) {
                if (e.touches && e.touches[[0]]()) return e.touches[[0]]().clientX;
                if (typeof e.clientX === 'number') return e.clientX;
                return 0;
            }

            // teclado
            document.addEventListener('keydown', (e) => {
                if (e.key === 'ArrowRight') goNext();
                if (e.key === 'ArrowLeft') goPrev();
            });

            // inicializa
            render();

            // debug API
            window._carousel = { goTo, goNext, goPrev, getCurrent: () => currentIndex };
        });
    </script>
</body>

</html>